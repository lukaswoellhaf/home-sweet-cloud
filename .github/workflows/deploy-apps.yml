name: Deploy Applications

on:
  workflow_dispatch:
    inputs:
      application:
        description: 'Which application(s) to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - portfolio-website
          - bytestash
          - monitoring

env:
  KUBECONFIG: /tmp/kubeconfig

jobs:
  deploy-portfolio-website:
    name: Deploy Portfolio Website
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.application == 'all' || github.event.inputs.application == 'portfolio-website' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Checkout repository lukaswoellhafcom
        uses: actions/checkout@v4
        with:
          repository: lukaswoellhaf/lukaswoellhafcom
          path: lukaswoellhafcom
          token: ${{ secrets.CHECKOUT_TOKEN }}
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Determine image tag
        id: image-tag
        run: |
          cd lukaswoellhafcom
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          TAG="main-${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using image tag from lukaswoellhafcom: $TAG"
          cd ..
      
      - name: Configure kubectl with service account
        run: |
          # Get cluster info from secrets
          CLUSTER_NAME="home-sweet-cloud"
          CLUSTER_API="https://${{ vars.SERVER_IP }}:6443"
          
          # Create kubeconfig with service account token
          kubectl config set-cluster "$CLUSTER_NAME" \
            --server="$CLUSTER_API" \
            --certificate-authority=<(echo "${{ secrets.CLUSTER_CA_CERT }}" | base64 -d) \
            --embed-certs=true
          
          kubectl config set-credentials deployment-sa \
            --token="${{ secrets.DEPLOYMENT_SA_TOKEN }}"
          
          kubectl config set-context deployment \
            --cluster="$CLUSTER_NAME" \
            --user=deployment-sa
          
          kubectl config use-context deployment
          
          # Verify connection
          echo "Testing cluster connection..."
          kubectl cluster-info
      
      - name: Deploy portfolio website
        run: |
          helm upgrade --install portfolio-website ./applications/portfolio-website \
            --namespace portfolio-website \
            --create-namespace \
            --set image.tag=${{ steps.image-tag.outputs.tag }} \
            --set imagePullSecret.username=lukaswoellhaf \
            --set imagePullSecret.password=${{ secrets.GHCR_TOKEN }} \
            --wait \
            --timeout 5m
          echo "Portfolio website deployed" >> $GITHUB_STEP_SUMMARY
  
  deploy-bytestash:
    name: Deploy ByteStash
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.application == 'all' || github.event.inputs.application == 'bytestash' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Configure kubectl with service account
        run: |
          # Get cluster info from secrets
          CLUSTER_NAME="home-sweet-cloud"
          CLUSTER_API="https://${{ vars.SERVER_IP }}:6443"
          
          # Create kubeconfig with service account token
          kubectl config set-cluster "$CLUSTER_NAME" \
            --server="$CLUSTER_API" \
            --certificate-authority=<(echo "${{ secrets.CLUSTER_CA_CERT }}" | base64 -d) \
            --embed-certs=true
          
          kubectl config set-credentials deployment-sa \
            --token="${{ secrets.DEPLOYMENT_SA_TOKEN }}"
          
          kubectl config set-context deployment \
            --cluster="$CLUSTER_NAME" \
            --user=deployment-sa
          
          kubectl config use-context deployment
          
          # Verify connection
          echo "Testing cluster connection..."
          kubectl cluster-info
      
      - name: Deploy ByteStash
        run: |
          helm upgrade --install bytestash ./applications/bytestash \
            --namespace code \
            --create-namespace \
            --set bytestash.jwtSecret=${{ secrets.BYTESTASH_JWT_SECRET }} \
            --wait \
            --timeout 5m
          echo "ByteStash deployed successfully" >> $GITHUB_STEP_SUMMARY

  deploy-monitoring:
    name: Deploy Monitoring
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.application == 'all' || github.event.inputs.application == 'monitoring' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Configure kubectl with service account
        run: |
          CLUSTER_NAME="home-sweet-cloud"
          CLUSTER_API="https://${{ vars.SERVER_IP }}:6443"
          
          kubectl config set-cluster "$CLUSTER_NAME" \
            --server="$CLUSTER_API" \
            --certificate-authority=<(echo "${{ secrets.CLUSTER_CA_CERT }}" | base64 -d) \
            --embed-certs=true
          
          kubectl config set-credentials deployment-sa \
            --token="${{ secrets.DEPLOYMENT_SA_TOKEN }}"
          
          kubectl config set-context deployment \
            --cluster="$CLUSTER_NAME" \
            --user=deployment-sa
          
          kubectl config use-context deployment
          kubectl cluster-info
      
      - name: Build Helm dependencies
        run: helm dependency build applications/monitoring/
      
      - name: Deploy monitoring
        run: |
          helm upgrade --install monitoring ./applications/monitoring \
            --namespace monitoring \
            --create-namespace \
            --wait \
            --timeout 10m \
            --set kube-prometheus-stack.grafana.adminUser=${{ secrets.GRAFANA_ADMIN_USERNAME }} \
            --set kube-prometheus-stack.grafana.adminPassword=${{ secrets.GRAFANA_ADMIN_PASSWORD }} \
            --set "kube-prometheus-stack.alertmanager.config.receivers[1].slack_configs[0].api_url=${{ secrets.DISCORD_WEBHOOK_URL }}"
          echo "Monitoring deployed successfully" >> $GITHUB_STEP_SUMMARY
