name: Deploy Applications

on:
  workflow_dispatch:

env:
  KUBECONFIG: /tmp/kubeconfig

jobs:
  deploy-portfolio-website:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Checkout repository lukaswoellhafcom
        uses: actions/checkout@v4
        with:
          repository: lukaswoellhaf/lukaswoellhafcom
          path: lukaswoellhafcom
          token: ${{ secrets.CHECKOUT_TOKEN }}
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Determine image tag
        id: image-tag
        run: |
          cd lukaswoellhafcom
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          TAG="main-${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using image tag from lukaswoellhafcom: $TAG"
          cd ..
      
      - name: Configure kubectl with service account
        run: |
          # Get cluster info from secrets
          CLUSTER_NAME="home-sweet-cloud"
          CLUSTER_API="https://${{ vars.SERVER_IP }}:6443"
          
          # Create kubeconfig with service account token
          kubectl config set-cluster "$CLUSTER_NAME" \
            --server="$CLUSTER_API" \
            --certificate-authority=<(echo "${{ secrets.CLUSTER_CA_CERT }}" | base64 -d) \
            --embed-certs=true
          
          kubectl config set-credentials deployment-sa \
            --token="${{ secrets.DEPLOYMENT_SA_TOKEN }}"
          
          kubectl config set-context deployment \
            --cluster="$CLUSTER_NAME" \
            --user=deployment-sa
          
          kubectl config use-context deployment
          
          # Verify connection
          echo "Testing cluster connection..."
          kubectl cluster-info
      
      - name: Deploy portfolio website
        run: |
          helm upgrade --install portfolio-website ./applications/portfolio-website \
            --namespace portfolio-website \
            --create-namespace \
            --set image.tag=${{ steps.image-tag.outputs.tag }} \
            --set imagePullSecret.username=lukaswoellhaf \
            --set imagePullSecret.password=${{ secrets.GHCR_TOKEN }} \
            --wait \
            --timeout 5m
          
          echo "Portfolio website deployed" >> $GITHUB_STEP_SUMMARY
