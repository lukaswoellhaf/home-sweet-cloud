# Monitoring stack configuration
kube-prometheus-stack:
  crds:
    # Auto-upgrade CRDs as part of helm upgrade (required when crossing major versions)
    upgradeJob:
      enabled: true

  # Disable components not accessible/relevant in k3s
  kubeEtcd:
    enabled: false
  kubeControllerManager:
    enabled: false
  kubeScheduler:
    enabled: false
  kubeProxy:
    enabled: false

  prometheus:
    prometheusSpec:
      # Pick up all ServiceMonitors and PodMonitors regardless of labels
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      retention: 7d
      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          cpu: 200m
          memory: 768Mi
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi

  alertmanager:
    # Disabled - Grafana Alerting handles routing and notifications
    enabled: false

  grafana:
    resources:
      requests:
        cpu: 20m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 256Mi
    persistence:
      enabled: true
      size: 2Gi
    grafana.ini:
      server:
        root_url: https://grafana.lukaswoellhaf.com
      auth.anonymous:
        enabled: false
      auth:
        disable_login_form: false
      unified_alerting:
        enabled: true
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.middlewares: default-https-redirect@kubernetescrd
      hosts:
        - grafana.lukaswoellhaf.com
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.lukaswoellhaf.com
    # Set via --set with GRAFANA_ADMIN_USERNAME/GRAFANA_ADMIN_PASSWORD as GitHub secrets in workflow
    adminUser: ""
    adminPassword: ""
    # Discord webhook URL set via --set in workflow
    # Alerting rules, contact points, and notification policy are in alerts.yaml
    env:
      DISCORD_WEBHOOK_URL: ""
    additionalDataSources:
      - name: Prometheus
        type: prometheus
        uid: prometheus
        url: http://monitoring-kube-prometheus-prometheus:9090
        access: proxy
        isDefault: true
      - name: Loki
        type: loki
        uid: loki
        url: http://monitoring-loki:3100
        access: proxy
        isDefault: false

  prometheus-node-exporter:
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 50m
        memory: 64Mi

  kube-state-metrics:
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 50m
        memory: 64Mi

# Log aggregation configuration
loki:
  deploymentMode: SingleBinary
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
      ring:
        kvstore:
          store: inmemory
    limits_config:
      retention_period: 168h  # 7 days
    compactor:
      retention_enabled: true
      delete_request_store: filesystem
    storage:
      type: filesystem
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
  singleBinary:
    replicas: 1
    resources:
      requests:
        cpu: 20m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 256Mi
    persistence:
      enabled: true
      size: 10Gi
  # Disable unneeded components for single-node setup
  gateway:
    enabled: false
  minio:
    enabled: false
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
  test:
    enabled: false
  lokiCanary:
    enabled: false
  # Disable all caching components (memcached) - not needed for single-node
  chunksCache:
    enabled: false
  resultsCache:
    enabled: false

# Log collector configuration
promtail:
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 50m
      memory: 64Mi
  config:
    clients:
      - url: http://monitoring-loki:3100/loki/api/v1/push
